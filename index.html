<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>沪金算盘 - 全球资产看板</title>
    <style>
        :root {
            --primary: #007aff;
            --up: #ff3b30;
            --down: #34c759;
            --gold: #d4af37;
            --card-bg: #ffffff;
            --bg: #f2f2f7;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --border: #e5e5ea;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            padding: 16px;
            box-sizing: border-box;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px 4px;
        }
        .header-left h1 { font-size: 28px; margin: 0; font-weight: 800; letter-spacing: -1px; }
        .header-left p { font-size: 13px; color: var(--text-sub); margin: 4px 0 0; font-weight: 500; }
        
        /* 世界时钟样式增强 */
        .world-clock-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            padding: 14px 10px;
            border-radius: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .clock-item { text-align: center; border-right: 1px solid var(--border); }
        .clock-item:last-child { border-right: none; }
        .clock-city { font-size: 11px; color: var(--text-sub); font-weight: 700; margin-bottom: 2px; display: block; }
        .clock-time { font-size: 16px; font-weight: 800; font-variant-numeric: tabular-nums; display: block; color: var(--text-main); }
        .clock-date { font-size: 10px; color: var(--text-sub); display: block; margin-top: 1px; }
        .clock-status { font-size: 9px; margin-top: 5px; display: inline-block; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: 600; }
        .clock-status.active { background: rgba(52, 199, 89, 0.15); color: var(--down); }

        .hero-card {
            background: linear-gradient(165deg, #1c1c1e 0%, #3a3a3c 100%);
            color: #fff;
            padding: 24px;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .hero-card h3 { margin: 0; font-size: 13px; opacity: 0.5; text-transform: uppercase; letter-spacing: 1.5px; }
        .hero-card .price { font-size: 48px; font-weight: 800; margin: 12px 0; font-variant-numeric: tabular-nums; }
        .hero-card .change-row { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; }

        .fx-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }
        .fx-item {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            user-select: none;
        }
        .fx-item:active { transform: scale(0.95); background-color: #f9f9f9; }
        .fx-item label { display: block; font-size: 10px; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; }
        .fx-item span { font-size: 14px; font-weight: 700; font-variant-numeric: tabular-nums; }

        .watchlist {
            background: var(--card-bg);
            border-radius: 32px;
            padding: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
            margin-bottom: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 12px 8px;
        }
        .section-header h3 { margin: 0; font-size: 18px; font-weight: 700; }
        
        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 12px;
            border-radius: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .stock-item:active { background: #f2f2f7; }
        .stock-info .name { font-weight: 700; font-size: 16px; display: block; }
        .stock-info .code { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 600; }
        .stock-price { text-align: right; }
        .price-now { font-weight: 700; font-size: 16px; display: block; }
        .price-pct { 
            font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 8px; 
            color: #fff; margin-top: 4px; display: inline-block; min-width: 55px;
        }

        .bg-up { background-color: var(--up); }
        .bg-down { background-color: var(--down); }

        .profit-tag { font-size: 10px; margin-top: 2px; font-weight: 600; }

        .controls { display: flex; gap: 8px; padding: 0 4px; margin-top: 12px; }
        input {
            flex: 1; height: 46px; border-radius: 14px; border: 1px solid var(--border);
            padding: 0 16px; background: #fff; font-size: 14px; outline: none;
        }
        .add-btn {
            background: var(--primary); color: #fff; border: none;
            width: 46px; height: 46px; border-radius: 14px; font-size: 20px; cursor: pointer;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal-content { background: #fff; padding: 24px; border-radius: 30px; width: 80%; max-width: 300px; }
        .modal-btns { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
        .modal-btns button { height: 44px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }

        footer { text-align: center; padding: 30px 20px; font-size: 11px; color: var(--text-sub); line-height: 1.6; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #34c759; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-left">
            <h1 id="current-date">--月--日</h1>
            <p>沪金算盘 · 全球视野</p>
        </div>
        <div class="status-box" style="text-align: right;">
            <div id="status"><span class="status-dot"></span><span style="font-size: 12px; font-weight: 600;">实时行情</span></div>
            <div id="update-time" style="font-size: 10px; color: var(--text-sub); margin-top: 2px;">--:--:--</div>
        </div>
    </header>

    <!-- 世界时钟模块 -->
    <div class="world-clock-bar">
        <div class="clock-item">
            <span class="clock-city">北京</span>
            <span class="clock-time" id="time-beijing">--:--</span>
            <span class="clock-date" id="date-beijing">--/--</span>
            <span class="clock-status" id="status-beijing">休市</span>
        </div>
        <div class="clock-item">
            <span class="clock-city">伦敦</span>
            <span class="clock-time" id="time-london">--:--</span>
            <span class="clock-date" id="date-london">--/--</span>
            <span class="clock-status" id="status-london">休市</span>
        </div>
        <div class="clock-item">
            <span class="clock-city">纽约</span>
            <span class="clock-time" id="time-newyork">--:--</span>
            <span class="clock-date" id="date-newyork">--/--</span>
            <span class="clock-status" id="status-newyork">休市</span>
        </div>
    </div>

    <div class="hero-card">
        <h3>上海金 AU9999 (元/克)</h3>
        <div id="gold-price" class="price">---.--</div>
        <div class="change-row">
            <span id="gold-change-val">--</span>
            <span id="gold-change-pct">--%</span>
        </div>
    </div>

    <div class="fx-grid" id="fx-matrix">
        <div class="fx-item" data-code="fx_susdcnh" onclick="toggleFx(this)">
            <label id="label-usdcnh">USD/CNH</label><span id="val-usdcnh">...</span>
        </div>
        <div class="fx-item" data-code="fx_seurcnh" onclick="toggleFx(this)">
            <label id="label-eurcnh">EUR/CNH</label><span id="val-eurcnh">...</span>
        </div>
        <div class="fx-item" data-code="fx_sjpycnh" onclick="toggleFx(this)">
            <label id="label-jpycnh">JPY/CNH</label><span id="val-jpycnh">...</span>
        </div>
        <div class="fx-item" data-code="fx_sgbpcnh" onclick="toggleFx(this)">
            <label id="label-gbpcnh">GBP/CNH</label><span id="val-gbpcnh">...</span>
        </div>
        <div class="fx-item" data-code="fx_shkdcnh" onclick="toggleFx(this)">
            <label id="label-hkdcnh">HKD/CNH</label><span id="val-hkdcnh">...</span>
        </div>
        <div class="fx-item" data-code="fx_sxauusd" onclick="toggleFx(this)">
            <label id="label-xauusd">XAU/USD</label><span id="val-xauusd">...</span>
        </div>
    </div>

    <div class="watchlist">
        <div class="section-header">
            <h3>自选资产</h3>
        </div>
        <div id="stock-list"></div>
        <div class="controls">
            <input type="text" id="new-code" placeholder="代码(如: 600519)">
            <button class="add-btn" onclick="addNewStock()">+</button>
        </div>
    </div>

    <footer>
        <br>
        国内新浪源行情 · 10s 自动轮询<br>
        沪金算盘专业版 · 投资伴侣
    </footer>
</div>

<div id="stock-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-top:0">管理资产</h3>
        <div style="margin-bottom:12px">
            <label style="font-size:11px;color:var(--text-sub)">成本价</label>
            <input type="number" id="input-cost" style="width:100%;box-sizing:border-box;margin-top:4px">
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:11px;color:var(--text-sub)">持仓量</label>
            <input type="number" id="input-hold" style="width:100%;box-sizing:border-box;margin-top:4px">
        </div>
        <div class="modal-btns">
            <button onclick="saveHoldings()" style="background:var(--primary);color:#fff">保存设置</button>
            <button onclick="deleteStock()" style="background:#fff;color:var(--up);border:1px solid var(--up)">删除资产</button>
            <button onclick="closeModal()" style="background:#f2f2f7;color:var(--text-main)">取消</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'HJSP_GLOBAL_V3';
    let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        codes: ['sh000001', 'hk00700', 'gb_aapl'],
        holdings: {}
    };

    let fxReverseState = {
        fx_susdcnh: false, fx_seurcnh: false, fx_sjpycnh: false,
        fx_sgbpcnh: false, fx_shkdcnh: false, fx_sxauusd: false
    };

    const FX_CODES = ['fx_susdcnh', 'fx_seurcnh', 'fx_sjpycnh', 'fx_sgbpcnh', 'fx_shkdcnh', 'fx_sxauusd'];
    const SPECIAL = ['gds_AU9999'];
    let currentDataMap = {};
    let currentEditingCode = null;

    // 更新世界时钟逻辑（包含日期）
    function updateWorldClocks() {
        const now = new Date();
        const config = [
            { id: 'beijing', timezone: 'Asia/Shanghai', market: 'A股', open: 930, close: 1500 },
            { id: 'london', timezone: 'Europe/London', market: '伦敦', open: 800, close: 1630 },
            { id: 'newyork', timezone: 'America/New_York', market: '美股', open: 930, close: 1600 }
        ];

        config.forEach(city => {
            const dateStr = now.toLocaleDateString('zh-CN', { timeZone: city.timezone, month: 'numeric', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('zh-CN', { timeZone: city.timezone, hour12: false, hour: '2-digit', minute: '2-digit' });
            
            document.getElementById(`time-${city.id}`).innerText = timeStr;
            document.getElementById(`date-${city.id}`).innerText = dateStr + '日';
            
            const [h, m] = timeStr.split(':').map(Number);
            const totalMin = h * 100 + m;
            const statusEl = document.getElementById(`status-${city.id}`);
            const isWeekend = [0, 6].includes(new Date(now.toLocaleString('en-US', {timeZone: city.timezone})).getDay());
            
            if (!isWeekend && totalMin >= city.open && totalMin <= city.close) {
                statusEl.innerText = '交易中';
                statusEl.classList.add('active');
            } else {
                statusEl.innerText = '休市';
                statusEl.classList.remove('active');
            }
        });
    }

    const d = new Date();
    document.getElementById('current-date').innerText = `${d.getMonth()+1}月${d.getDate()}日`;

    // 核心行情抓取（增强版新浪源）
    function fetchSinaData(codes) {
        return new Promise((resolve) => {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            // 采用动态脚本加载，确保国内网络穿透力
            iframe.srcdoc = `
                <meta name="referrer" content="no-referrer">
                <script src="https://hq.sinajs.cn/list=${codes.join(',')}"><\/script>
                <script>
                    window.parent.postMessage({
                        type: 'SINA_DATA',
                        data: Array.from(Object.keys(window)).filter(k => k.startsWith('hq_str_')).reduce((obj, k) => {
                            obj[k.replace('hq_str_', '')] = window[k]; return obj;
                        }, {})
                    }, '*');
                <\/script>
            `;
            const onMsg = (e) => { 
                if (e.data?.type === 'SINA_DATA') { 
                    window.removeEventListener('message', onMsg); 
                    if(iframe.parentNode) document.body.removeChild(iframe); 
                    resolve(e.data.data); 
                } 
            };
            window.addEventListener('message', onMsg);
            document.body.appendChild(iframe);
            setTimeout(() => { 
                window.removeEventListener('message', onMsg); 
                if(iframe.parentNode) document.body.removeChild(iframe); 
                resolve(null); 
            }, 8000);
        });
    }

    async function refresh() {
        updateWorldClocks();
        const data = await fetchSinaData([...FX_CODES, ...SPECIAL, ...appData.codes]);
        if (!data) return;
        currentDataMap = data;
        document.getElementById('update-time').innerText = new Date().toLocaleTimeString();

        // 黄金 AU9999 解析
        const au = data['gds_AU9999']?.split(',');
        if(au && au.length > 1) {
            const p = parseFloat(au[0]), c = parseFloat(au[7]);
            document.getElementById('gold-price').innerText = p.toFixed(2);
            document.getElementById('gold-change-val').innerText = (p-c > 0 ? '+' : '') + (p-c).toFixed(2);
            document.getElementById('gold-change-pct').innerText = (p-c > 0 ? '+' : '') + ((p-c)/c*100).toFixed(2) + '%';
        }

        updateFxUI();
        renderList(data);
    }

    // 汇率UI更新（处理国内API返回结构）
    function updateFxUI() {
        FX_CODES.forEach(code => {
            const raw = currentDataMap[code];
            if(!raw) return;
            const p = raw.split(',');
            // 国内新浪外汇接口索引1通常是中间价/现价
            let originalPrice = parseFloat(p[1]);
            // 特殊情况：如果是全球黄金 XAU/USD，解析结构可能不同
            if (code === 'fx_sxauusd') originalPrice = parseFloat(p[2]);
            if (isNaN(originalPrice) || originalPrice === 0) originalPrice = parseFloat(p[8]); // 备用索引

            const suffix = code.includes('_s') ? code.split('_s')[1] : code.split('fx_')[1];
            const valId = 'val-' + suffix;
            const labId = 'label-' + suffix;
            
            const isReverse = fxReverseState[code];
            let displayPrice, displayLabel;
            const pair = suffix.toUpperCase();
            const base = pair.substring(0, 3);
            const target = pair.substring(3);

            if (isReverse) {
                displayPrice = (1 / originalPrice).toFixed(target === 'JPY' ? 6 : 4);
                displayLabel = `${target}/${base}`;
            } else {
                displayPrice = originalPrice.toFixed(pair === 'XAUUSD' ? 2 : 4);
                displayLabel = `${base}/${target}`;
            }
            
            const vEl = document.getElementById(valId);
            const lEl = document.getElementById(labId);
            if(vEl) vEl.innerText = displayPrice;
            if(lEl) lEl.innerText = displayLabel;
        });
    }

    window.toggleFx = function(el) {
        const code = el.getAttribute('data-code');
        fxReverseState[code] = !fxReverseState[code];
        updateFxUI();
    };

    function renderList(data) {
        const list = document.getElementById('stock-list');
        list.innerHTML = '';
        appData.codes.forEach(code => {
            const raw = data[code]; if(!raw) return;
            const p = raw.split(',');
            let name, price, lastClose;
            if (code.startsWith('sh000') || code.startsWith('sz399')) { name=p[0]; price=p[1]; lastClose=p[2]; }
            else if (code.startsWith('hk')) { name=p[1]; price=p[6]; lastClose=p[3]; }
            else if (code.startsWith('gb_')) { name=p[0]; price=p[1]; lastClose=p[26]; }
            else { name=p[0]; price=p[3]; lastClose=p[2]; }
            
            const curP = parseFloat(price), lastP = parseFloat(lastClose);
            const isUp = curP >= lastP;
            const pct = lastP ? ((curP - lastP)/lastP*100).toFixed(2) : '0.00';
            
            let profitHtml = '';
            const hold = appData.holdings[code];
            if(hold && hold.cost) {
                const profit = (curP - hold.cost) * (hold.count || 0);
                profitHtml = `<span class="profit-tag" style="color:${profit>=0?'var(--up)':'var(--down)'}">盈亏: ${profit>=0?'+':''}${profit.toFixed(2)}</span>`;
            }

            const item = document.createElement('div');
            item.className = 'stock-item';
            item.onclick = () => openModal(code, name);
            item.innerHTML = `
                <div class="stock-info">
                    <span class="name">${name}</span>
                    <span class="code">${code}</span>
                    ${profitHtml}
                </div>
                <div class="stock-price">
                    <span class="price-now">${curP.toFixed(2)}</span>
                    <span class="price-pct ${isUp?'bg-up':'bg-down'}">${isUp?'+':''}${pct}%</span>
                </div>
            `;
            list.appendChild(item);
        });
    }

    function openModal(code, name) {
        currentEditingCode = code;
        document.getElementById('modal-title').innerText = name;
        const hold = appData.holdings[code] || {cost:'', count:''};
        document.getElementById('input-cost').value = hold.cost;
        document.getElementById('input-hold').value = hold.count;
        document.getElementById('stock-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('stock-modal').style.display = 'none'; }
    function saveHoldings() {
        const cost = parseFloat(document.getElementById('input-cost').value);
        const count = parseFloat(document.getElementById('input-hold').value);
        if(!isNaN(cost)) appData.holdings[currentEditingCode] = {cost, count};
        save(); closeModal(); refresh();
    }
    function deleteStock() {
        appData.codes = appData.codes.filter(c => c !== currentEditingCode);
        delete appData.holdings[currentEditingCode];
        save(); closeModal(); refresh();
    }
    function addNewStock() {
        let code = document.getElementById('new-code').value.trim().toLowerCase();
        if(!code) return;
        if(!isNaN(code)) {
            if (code.length === 6) {
                code = (code.startsWith('6')||code.startsWith('9')) ? 'sh'+code : 'sz'+code;
            } else if (code.length === 5) {
                code = 'hk'+code;
            }
        }
        if(!appData.codes.includes(code)) { appData.codes.push(code); save(); refresh(); }
        document.getElementById('new-code').value = '';
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }

    // 初始化运行
    refresh();
    setInterval(refresh, 10000);
    setInterval(updateWorldClocks, 60000);
</script>
</body>
</html>
